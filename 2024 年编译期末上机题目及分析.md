# 2024 年编译期末上机题目及分析

本次共有两项主要改动：一是新增一个一元操作 `++`，二是允许在 `if` 语句中声明变量。

总体而言难度不大，且均不需要改动中间代码以后的部分。但一定要多多温习自己写的代码，至少应该在考前再过一遍，理解其中的细节。

## 一元操作 `++`

`++` 是一个一元操作符，用于将一个变量的值加一（但原有变量的值不会发生变化，和 C 语言不同）。例如，`++a` 的值是 `a + 1`，但不会改变 `a` 的值。

文法如下：

```
UnaryOp ::= '+' | '-' | '!' | '++'
```

允许 `++ ++a` 连用，也允许 `+ ++a` 这种，但不允许 `+++a` 或者 `++++a` 等等。

直接在 `UnaryExpr` 的相关地方增加处理即可，需要注意一些细节：

- 常量计算不要忘记新增 `++` 的情况。比如 `int a[++ 3]` 这种，如果忽视了新增运算，可能会出错。
- 生成中间代码时，要注意类型转换，`char` 与 `int` 等等。

## 在 `if` 语句中声明变量

在 `if` 语句中，可以声明变量。例如：

```
if (int a = 1) {
    ...
}
```

文法如下，其中定义的只会是普通变量，不会是数组或者 const 变量：

```
Stmt ::= ... | 'if' '(' BType Ident '=' VarInit ')' Stmt ['else' Stmt]
```

题目明确说明了，下列两种情况等价：

```
if (int a = b) {
    ...
}
```

```
{
    int a = b;
    if (a) {
        ...
    }
}
```

因此处理符号表变得比较简单，只需要在处理 `if` 语句前新建一个作用域，并在完成后退出作用域即可。需要注意一些细节：

- `if` 语句中声明的变量，只在 `if` 语句中有效，不会影响到外部的同名变量。
- `if` 语句中声明的变量，并没有像别的变量一样在 `***Decl` 中处理，而是单独进行的，需要注意自己的代码，不要忽视一些必要的标记与处理。
- 注意测试详尽的情况，比如重定义、未定义、变量覆盖等等。
- 不要对初始值重复计算。
